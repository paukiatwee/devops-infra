- name: Ensure Kubernetes repo is enabled
  yum_repository:
    name: kubernetes
    description: Kubernetes
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg  https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    gpgcheck: no
    repo_gpgcheck: no

- name: Ensure Gluster related packages are installed
  yum: name={{ item }}
  with_items:
    - centos-release-gluster39

- name: Ensure Kubernetes related packages are installed
  yum: name="{{ item }}"
  with_items:
    - glusterfs-client
    - kubelet
    - kubeadm
    - kubectl
    - kubernetes-cni

- name: Ensure SELinux is in Permissive mode
  selinux: policy=targeted state=permissive

- name: Ensure Kubernetes related services are started
  service: name="{{ item }}" enabled=yes state=started
  with_items:
    - kubelet

- name: Ensure Kubernetes resources directory exist
  file: name=/etc/k8s state=directory

- name: Copy Kubernetes resources
  template: src={{ item }} dest=/etc/k8s/{{ item }}
  with_items:
    - patch.sh
    - kubeadm.conf
    - gluster.yml
    - traefik.yml
    - influxdb.yml
    - grafana.yml
    - gogs.yml
    - jenkins.yml
    - default-backend.yml

- name: Init Kubernetes
  command: kubeadm init --apiserver-advertise-address {{ hostvars[groups['k8s_master'][0]]['ansible_' + network_interface]['ipv4']['address'] }}

- name: Ensure kube config is exist
  file: path=/home/vagrant/.kube state=directory owner=vagrant group=vagrant

- name: Ensure kube config is exist
  file: path=/root/.kube state=directory owner=root group=root

- name: Init kubectl config
  copy: src=/etc/kubernetes/admin.conf dest=/home/vagrant/.kube/config remote_src=yes owner=vagrant group=vagrant

- name: Init kubectl config
  copy: src=/etc/kubernetes/admin.conf dest=/root/.kube/config remote_src=yes owner=root group=root

- name: Install Kubernetes network add-on
  command: kubectl apply -f https://git.io/weave-kube-1.6

- name: Ensure master is available for running pods
  command: kubectl taint nodes --all node-role.kubernetes.io/master-

- name: Create Kubernetes resources
  command: "{{ item }} chdir=/etc/k8s/"
  with_items:
    - kubectl apply -f gluster.yml
    - kubectl apply -f traefik.yml
    - kubectl apply -f influxdb.yml
    - kubectl apply -f grafana.yml
    # - kubectl apply -f gogs.yml
    # - kubectl apply -f jenkins.yml
    # - kubectl apply -f default-backend.yml
